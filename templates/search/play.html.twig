{% extends "base.html.twig"  %}
{% set page = 'docs' %}
{% block title %}Search Playground{% endblock %}

{% block body %}
<div class="two-pane">
    <aside>
        woop
    </aside>
    <main style="max-width: 100%;">

        <h2>Search Play Testing</h2>

        <div class="playground">
            <div>
                <div class="form-row">
                    <label for="endpoint">Endpoint</label>
                    <input name="endpoint" id="endpoint" placeholder="URL of API Endpoint" class="form-control" value="{{ app.request.getSchemeAndHttpHost() }}">
                </div>
                <br>
                <div class="form-row">
                    <label for="indexes">Indexes</label>
                    <textarea name="indexes" id="indexes" placeholder="Search Indexes" class="form-control">item,achievement,instantcontent</textarea>
                </div>
                <br>
                <div class="form-row">
                    <label for="body">Body</label>
                    <textarea name="body" id="body" placeholder="Elastic Search Query" class="form-control" rows="20"></textarea>
                </div>
                <br>
                <button class="btn btn-search-test btn-success" type="button">Search</button>
            </div>
            <div>
                <label for="endpoint">Response</label>
                <div class="playground-response" id="playground-response"><pre></pre></div>
            </div>
        </div>

    </main>
</div>
{% endblock %}

{% block javascripts %}
<script>
let query = {
    "query": {
        "bool": {
            "must": [
                {
                    "wildcard": {
                        "NameCombined_en": "*aiming*"
                    }
                }
            ],
            "filter": [
                {
                    "range": {
                        "ItemSearchCategory.ID": {
                            "gt": "1"
                        }
                    }
                },
                {
                    "range": {
                        "LevelItem": {
                            "gte": "100"
                        }
                    }
                },
                {
                    "range": {
                        "LevelItem": {
                            "lte": "125"
                        }
                    }
                }
            ]
        }
    },
    "from": 0,
    "size": 10,
    "sort": [
        {
            "LevelItem": "desc"
        }
    ]
};

let $searchTestButton = $('.btn-search-test');
let $searchResponseBox = $('#playground-response').find('pre');

$('#body').html(
    JSON.stringify(query, null, 2)
);

$searchResponseBox.text(
    '// Response will show here'
);

$searchTestButton.on('click', function() {
    let data = {
        indexes: $('#indexes').val().trim(),
        body: JSON.parse($('#body').val().trim()),
    };

    $searchTestButton.text('Searching ...').attr("disabled", true);

    $.ajax({
        url: $('#endpoint').val().trim() + '/search',
        type: "POST",
        data: JSON.stringify(data),
        dataType: "json",
        contentType: "application/json",
        processData: false,
        success: function(response) {
            console.log(response);

            $searchResponseBox.text(
                JSON.stringify(response, null, 2)
            );
        },
        error: function(a,b,c) {
            if (a.responseText[0] === '{') {
                $searchResponseBox.text(
                    JSON.stringify(JSON.parse(a.responseText), null, 2)
                );
            } else {
                $searchResponseBox.text(
                    'Request Error: View browser console and network tab for more information.'
                );
            }

            console.error(a,b,c);
        },
        complete: function() {
            $searchTestButton.text('Search').attr("disabled", false);
        }
    });
});
</script>
{% endblock %}
